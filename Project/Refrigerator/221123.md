# jwt진짜 완성하기

## 현재상황
기본적인 로직은 대부분 잘 동작한다  
이제 회원관련 작업이 남았는데 스프링 시큐리티와 jwt를 사용한 로그인이 잘 되지 않는다.

### 로그인 과정
1. /login 페이지에서 username, password입력
2. UserDetailsService를 구현한 클래스가 로그인 감지, 인증객체 생성
3. jwtAuthenticationFilter에서 객체 생성후 저장  
4. 로그인 성공하면 토큰생성, 쿠키저장

### 트러블 슈팅
- 로그인 인식  
스프링 시큐리티가 '로그인 요청이 로그인 요청인지' 알수있어야한다.  
두가지 방법을 알고있다.
    - formlogin  
    전에 thymeleaf로 게시판을 만들었을때 사용한 옵션이다.  
    로그인 경로를 설정해서 로그인요청에 따른 응답을 설정할 수 있다.  
    : 적용 결과 UserDetailsService가 로그인 요청을 정상적으로 인식하는데  
    jwt관련 필터로 요청이 넘어가질 않는다.  

    - filter.setFilterProcessesUrl  
    필터에 로그인 요청 경로를 설정하는 방법이다.  
    : 여기서 중요한건 이 경로에서 요청한게 로그인이다. 가 아니라  
    수행된 결과를 위 경로로 보내야한다는 것이다.  
    그래서 그냥 login페이지를 설정하면 접근도 안된다.   

    - 경과  
    attemptAuthentication의 로직은 json으로 넘어온 요청을 받아 처리한다.  
    하지만 나는 model을 사용해서 템플릿으로 직접 데이터를 전달하고 있기때문에 기본적으로 응답을 json으로 하지 않는다.  
    그렇다면 로그인에 대한 응답만 @ResponseBody를 사용하면 되지 않을까 싶은데,  
    /login을 filterProcessUrl로 설정해서 login에서 post 요청을 보내긴 커녕 접근조차 할 수 없다.  
    - 그래서 임시로 logins라는 페이지를 로그인 페이지로 쓰고, 결과를 login으로 전송하려하는데 json파일을 원하는 곳으로 리다이렉트할 수 있는지, 애초에 그렇게해도 인식하는지를 모르겠다.  
        - 결과   
        : redirectAttribute로 로그인 dto를 전송하니 dto를 string으로 변환할 수 없다는 오류가 나왔다.  
        그래서 혹시나 싶어 member객체를 찾아서 엔티티를 직접 전송해봤는데 이번엔 전과 같은 오류(파싱할게 없다)가 났다. 

    - 결론 : **세션 방식을 사용하자**   
    jwt를 사용하려한건 연습과 호기심이었다.  
    하지만 진행하면할수록 `굳이?`라는 생각이 들었다.  
    스프링 시큐리티에 대한 이해가 부족한것도 그렇지만  
    jwt를 적용하려면 api방식을 흉내내야했는데 그럴거면 세션을 쓰는게 훨씬 간편하다.  
    api방식을 굳이 흉내내면서까지 써야하나 싶은 생각이 들어서 세션방식으로 전환하고자한다.  
    게다가 지금 프로젝트의 목표는 스프링 시큐티리 심화과정은 아니다.  
    좀 더 프로젝트를 진행하다 다시 도전해봐야겠다.  
    아니면 템플릿을 버리던가

