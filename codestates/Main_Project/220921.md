# 메인 프로젝트
## 오늘 할 일
- 시큐리티 적용

---

### 트러블 슈팅
- OneToMany List가 null인 문제  
OneToMany 연관관계 매핑된 List가 조회시 null로 나왔다.  
문제는 null인게 맞다는 것이다. 방금 등록한 회원의 반려동물 정보가 등록되어있을리가 없지 않은가.  
    - 오류는 매퍼만 가리키고있어서 무엇이 문제인가 했는데  
    엔티티 생성자에서 연관관계 매핑되는 것들까지 생성되게 만들어놔서 그랬다.  
    연관관계 매핑으로 조회하면되는데 생성자가 계속 방해한것이다.

- 회원의 강아지가 참여하고있는 모임정보 조회  
현재 모임에 참여하는 주체가 회원의 '강아지'라서 회원 페이지에서 회원 입장의 모임을 조회하려면 강아지를 거쳐서 조회해야한다.  
처음에는 회원도 모임안에 포함되도록 설계했는데 멘토님 말씀을 듣고 불필요한 연관관계라는 생각이 들어 취소했다.  
그때는 그냥 한번 거쳐서 조회하면 되겠지 생각했는데 코드로 구현하고자 하니 이중반복문이 나왔다.  
    ```java
    List<CommunityDto.compactResponse> communityList = new ArrayList<>();
    for (int i = 0; i < member.getPetList().size(); i++) {
        for (int j = 0; j < member.getPetList().get(i).getCommunityPets().size(); j++) 
            Community community = member.getPetList().get(i).getCommunityPets().get(j).getCommunity();
            CommunityDto.compactResponse compactResponse = new CommunityDto.compactResponse(community)
            if (!communityList.contains(compactResponse)){
                communityList.add(compactResponse);
        }
    }
    ```
    스스로 '이게 맞나?...'라고 생각했는데 같이 공부하는 윤조님에게 너무 객체 중심으로 생각하는것 같다는 이야기를 들었다.  
    데이터를 조회해야하니까 확실히 DB측면에서 더 간단하게 해결할 수 있을것같은데 쿼리나 데이터베이스에 대한 이해가 여전히 없다는 생각이 들었다.  
    JPA에 완전히 의존하면서 JPA에 대한 이해가없다니! 말로만 할게아니라 얼른 공부를 해야한다. 오늘부터 당장 강의를 들어야겠다.  

- 트랜잭션문제  
트랜잭션 없이 코드를 짜다 드디어 트랜잭션 문제를 만나게되었다.  
모임 참가시 로그인한 회원의 강아지 목록을 응답해야했는데  
여기서 `org.hibernate.LazyInitializationException: failed to lazily initialize a collection of role: ~~`라고 하는 오류가 발생했다.  
찾아보니 메서드를 호출해서 사용하는 과정에서 영속성 컨텍스트가 종료되어 버려서, 지연 로딩을 할 수 없어 발생하는 오류라고 한다.  
트랜잭션을 공부해야한다고 생각만했지 바로 당장 필요할것이라곤 생각하지않았는데  
이렇게 만나게되니 정말 할 수 있는건 검색밖에없었다. 
문제는 검색을 해도 해답을 이해할 수가 없고 해결해도 이게 왜 되는건지 제대로 알 수 없다는 것이다.  
우선 조회하는 부분에서 지연로딩이 아닌 즉시로딩으로 변경해서 해결했다.  
트랜잭션도 시급하다.  

- 갑자기 만난 무한참조  
위 트랜잭션 오류를 수정하던 중, 정확하게는 뭣도 모르고 검색하면서 이것저것 하던 중에 갑자기 무한참조오류가 떴다.  
그것도 오류때문에 수정하던 코드가 아니라 평소에 잘되던 조회코드에서 오류가 났다.  
나는 건드린게 전혀 없다고 생각해서 무한참조 오류가 트랜잭션이나 시큐리티와 관련해서 발생한것이라 생각했다. 그 부분들을 잘 모르기때문이었다.  
수없이 삽질을 하다가 혹시 정말 그냥 무한참조 오류가 아닌가 하고 내가 수정하면서 변경한 코드들을 살펴봤는데 역시나 내가 건드린게 있었다.  
원래 dto를 통해 응답하던 것을 ResponseEntity를 사용해서 응답한다고 바꾼것이  
dto가 아니라 엔티티 자체를 반환해버려서 생긴 오류였다.  
너무 정신이 없어서 발생한 일이었다.  

---

### 후기
- 시간은 하나도 여유롭지 않다.  
어제까지만해도 `너무 빨리 해버리면 그 뒤에 뭘 하지`라고 생각했는데  
본격적으로 코드를 시험하면서 정말 수많은 오류들을 만났다. 그리고 절반정도는 분야에대한 기초지식이 부족해서 일어난 오류였다.  
정규 학습시간에만 프로젝트 코드를 작성하고, 급한경우가 아니면 기본 개념을 공부하면서 프로젝트를 탄탄하게 해야겠다 다짐했는데  
오늘 오류들을 만나면서 온전히 오류수정에만 시간을 쓰게되었다.  
당장 코드를 리팩토링하는것만해도 메인프로젝트 시간을 거의 다 쓸것같다.  
기본에 충실하기도 어렵다.